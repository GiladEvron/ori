<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>×’×™××•××˜×¨×™×” ×¢× ××•×¨×™</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Heebo:wght@900&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Heebo',sans-serif;background:#07090F;color:#D8EEFF;min-height:100vh;direction:rtl;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:linear-gradient(rgba(0,229,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.03) 1px,transparent 1px);
  background-size:40px 40px;}

/* â”€â”€ INSTRUCTIONS SCREEN â”€â”€ */
#splash{
  position:fixed;inset:0;z-index:9000;
  display:flex;align-items:flex-start;justify-content:center;
  background:#07090F;padding:20px 16px 32px;overflow-y:auto;
}
.splash-grid{position:absolute;inset:0;pointer-events:none;
  background:linear-gradient(rgba(0,229,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.03) 1px,transparent 1px);
  background-size:40px 40px;}
.splash-hidden{display:none!important;}

.splash-inner{position:relative;z-index:1;width:100%;max-width:400px;padding-top:16px;}

/* title block */
.splash-title-block{text-align:center;margin-bottom:24px;}
.splash-icon{font-size:40px;margin-bottom:8px;}
.splash-heading{font-family:'Heebo',sans-serif;font-weight:900;font-size:32px;
  color:#00E5FF;letter-spacing:2px;text-shadow:0 0 20px rgba(0,229,255,.4);margin-bottom:4px;}
.splash-subtitle{font-size:18px;font-weight:900;color:rgba(216,238,255,.4);letter-spacing:1px;}

/* section blocks */
.instr-section{
  background:#0E1122;border:1.5px solid #1A2140;border-radius:12px;
  padding:16px 18px;margin-bottom:12px;
}
.instr-bonus{border-color:rgba(255,214,0,.3);background:rgba(255,214,0,.04);}
.instr-label{
  font-family:'Heebo',sans-serif;font-size:16px;letter-spacing:1px;
  color:#00E5FF;margin-bottom:12px;
}

/* topics list */
.instr-topics{display:flex;flex-direction:column;gap:7px;}
.itopic{
  padding:9px 12px;border-radius:8px;
  border:1.5px solid color-mix(in srgb, var(--c) 30%, transparent);
  background:color-mix(in srgb, var(--c) 6%, transparent);
  color:var(--c);font-size:17px;font-weight:900;
}

/* rules */
.instr-rule{display:flex;align-items:center;gap:12px;margin-bottom:9px;}
.instr-rule:last-child{margin-bottom:0;}
.irule-badge{
  flex-shrink:0;min-width:44px;height:36px;border-radius:8px;
  border:1.5px solid color-mix(in srgb, var(--c) 60%, transparent);
  background:color-mix(in srgb, var(--c) 12%, transparent);
  color:var(--c);
  font-family:'Orbitron',monospace;font-weight:900;font-size:13px;
  display:flex;align-items:center;justify-content:center;
}
.irule-text{font-size:18px;font-weight:900;color:rgba(216,238,255,.7);line-height:1.4;}

/* start button */
.start-btn{
  width:100%;margin-top:6px;padding:18px;border-radius:12px;
  border:2px solid #00E5FF;background:rgba(0,229,255,.1);color:#00E5FF;
  font-family:'Heebo',sans-serif;font-size:26px;font-weight:900;cursor:pointer;
  box-shadow:0 0 28px rgba(0,229,255,.4);
  animation:sbpulse 2.2s ease-in-out infinite;
  transition:background .12s;
}
.start-btn:active{background:rgba(0,229,255,.2);}
@keyframes sbpulse{0%,100%{box-shadow:0 0 28px rgba(0,229,255,.4);}50%{box-shadow:0 0 50px rgba(0,229,255,.7);}}

.area-q{margin-top:10px;padding:8px 12px;background:rgba(255,214,0,.1);border:1.5px solid rgba(255,214,0,.4);border-radius:8px;font-size:15px;font-weight:900;color:rgba(216,238,255,.8);}
/* â”€â”€ MAIN APP â”€â”€ */
#app{display:none;padding:14px 12px 60px;}
#app.show{display:block;}
.wrap{position:relative;z-index:1;max-width:420px;margin:0 auto;}

/* â”€â”€ HEADER BAR â”€â”€ */
.hbar{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:16px;gap:10px;
}
.htitle{font-family:'Orbitron',monospace;font-weight:900;font-size:15px;color:#00E5FF;letter-spacing:2px;white-space:nowrap;}
.score-row{display:flex;align-items:center;gap:8px;}
.score-box{
  font-family:'Orbitron',monospace;font-weight:900;font-size:14px;
  background:#0B0D18;border:1.5px solid #FFD600;border-radius:7px;
  padding:6px 12px;color:#FFD600;
  box-shadow:0 0 10px rgba(255,214,0,.3);white-space:nowrap;
}
.bonus-count{
  font-family:'Orbitron',monospace;font-weight:900;font-size:13px;
  background:#0B0D18;border:1.5px solid rgba(255,31,110,.4);border-radius:7px;
  padding:5px 10px;color:rgba(255,31,110,.6);white-space:nowrap;
}
.bonus-count.lit{border-color:#FF1F6E;color:#FF1F6E;box-shadow:0 0 10px rgba(255,31,110,.4);animation:blit .6s ease infinite;}
@keyframes blit{0%,100%{opacity:1;}50%{opacity:.5;}}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;}
.tab{flex:1;min-width:62px;padding:9px 4px;border-radius:8px;border:1.5px solid #1A2140;
  background:#0B0D18;color:rgba(216,238,255,.38);font-family:'Heebo',sans-serif;
  font-weight:900;font-size:13px;cursor:pointer;text-align:center;transition:all .15s;position:relative;}
.tab.on{border-color:#00E5FF;background:rgba(0,229,255,.1);color:#00E5FF;box-shadow:0 0 12px rgba(0,229,255,.35);}
.tab-prog{
  position:absolute;bottom:3px;right:50%;transform:translateX(50%);
  font-family:'Orbitron',monospace;font-size:9px;color:rgba(0,229,255,.5);
  letter-spacing:0;
}
.tab.on .tab-prog{color:rgba(0,229,255,.8);}

/* â”€â”€ CARD â”€â”€ */
.card{background:#0E1122;border:2px solid #00E5FF;border-radius:14px;padding:22px 18px 20px;
  box-shadow:0 0 34px rgba(0,229,255,.3),0 0 0 1px #07090F;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:-2px;right:-2px;width:20px;height:20px;
  border-top:2.5px solid #FF1F6E;border-right:2.5px solid #FF1F6E;border-radius:0 14px 0 0;}
.card::after{content:'';position:absolute;bottom:-2px;left:-2px;width:20px;height:20px;
  border-bottom:2.5px solid #FF1F6E;border-left:2.5px solid #FF1F6E;border-radius:0 0 0 14px;}
.sweep{position:absolute;inset:0;pointer-events:none;
  background:linear-gradient(transparent,rgba(0,229,255,.025),transparent);animation:sw 5s ease-in-out infinite;}
@keyframes sw{0%{transform:translateY(-100%);}100%{transform:translateY(200%);}}
.card>*{position:relative;z-index:1;}

/* â”€â”€ SECTION HEADER â”€â”€ */
.sec-hd{margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid #1A2140;
  display:flex;align-items:flex-start;justify-content:space-between;gap:8px;}
.sec-titles{}
.sec-title{font-size:20px;font-weight:900;color:#D8EEFF;}
.sec-sub{font-size:13px;font-weight:900;color:rgba(216,238,255,.38);margin-top:2px;}
.sec-pbar{text-align:left;min-width:60px;}
.sec-pnum{font-family:'Orbitron',monospace;font-size:18px;font-weight:900;color:#00E5FF;}
.sec-pmax{font-family:'Orbitron',monospace;font-size:11px;color:rgba(0,229,255,.38);}
.sec-pbtrack{width:60px;height:4px;background:rgba(0,229,255,.1);border-radius:2px;margin-top:4px;overflow:hidden;}
.sec-pbfill{height:100%;background:#00E5FF;border-radius:2px;transition:width .4s;}

/* â”€â”€ SHAPE BOX â”€â”€ */
.shape-box{background:rgba(0,229,255,.018);border:1px solid #1A2140;border-radius:10px;
  height:180px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;overflow:visible;}
.shape-box svg{display:block;width:100%;height:100%;overflow:visible;}

/* â”€â”€ FORMULA â”€â”€ */
.fml{display:flex;justify-content:center;margin-bottom:10px;}
.chip{font-family:'Heebo','Arial Hebrew',sans-serif;font-size:20px;font-weight:900;letter-spacing:0;color:#00E5FF;
  background:rgba(0,229,255,.1);border:1.5px solid rgba(0,229,255,.3);border-radius:8px;padding:8px 20px;direction:rtl;}

/* â”€â”€ QTEXT â”€â”€ */
.qtext{font-size:21px;font-weight:900;text-align:center;line-height:1.5;color:#D8EEFF;margin-bottom:16px;}

/* â”€â”€ MCQ â”€â”€ */
.mcq{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.mb{padding:18px 6px;border-radius:10px;border:2px solid #1A2140;background:#0B0D18;
  color:#00E5FF;font-family:'Orbitron',monospace;font-weight:900;font-size:28px;cursor:pointer;transition:all .14s;}
.mb:hover:not(:disabled){border-color:#00E5FF;box-shadow:0 0 16px rgba(0,229,255,.45);transform:translateY(-2px);}
.mb:active:not(:disabled){transform:scale(.93);}
.mb.ok{border-color:#00FF85!important;color:#00FF85!important;background:rgba(0,255,133,.1)!important;
  box-shadow:0 0 26px rgba(0,255,133,.5)!important;animation:pop .4s cubic-bezier(.34,1.56,.64,1);}
.mb.no{border-color:#FF1F6E!important;color:#FF1F6E!important;background:rgba(255,31,110,.1)!important;animation:shk .35s ease;}
.mb:disabled{cursor:default;opacity:.4;}
.mb.ok:disabled,.mb.no:disabled{opacity:1;}
@keyframes pop{from{transform:scale(.85);}to{transform:scale(1);}}
@keyframes shk{0%,100%{transform:translateX(0);}20%{transform:translateX(-7px);}40%{transform:translateX(7px);}60%{transform:translateX(-4px);}80%{transform:translateX(4px);}}

/* â”€â”€ FEEDBACK â”€â”€ */
.fb{margin-top:12px;padding:14px 16px;border-radius:10px;font-size:19px;font-weight:900;text-align:center;display:none;}
.fb.ok{display:block;border:2px solid #00FF85;background:rgba(0,255,133,.1);color:#00FF85;box-shadow:0 0 20px rgba(0,255,133,.4);}
.fb.no{display:block;border:2px solid #FF1F6E;background:rgba(255,31,110,.1);color:#FF1F6E;box-shadow:0 0 16px rgba(255,31,110,.4);}
.fb.wn{display:block;border:2px solid #FFD600;background:rgba(255,214,0,.1);color:#FFD600;box-shadow:0 0 16px rgba(255,214,0,.4);}
.fb-sub{font-size:14px;font-weight:900;opacity:.7;margin-top:5px;}

/* â”€â”€ NEXT BTN â”€â”€ */
.nxt{display:none;width:100%;margin-top:12px;padding:15px;border-radius:10px;
  border:2px solid #00E5FF;background:rgba(0,229,255,.1);color:#00E5FF;
  font-family:'Heebo',sans-serif;font-size:20px;font-weight:900;cursor:pointer;
  box-shadow:0 0 14px rgba(0,229,255,.3);}
.nxt:active{background:rgba(0,229,255,.2);}

/* â”€â”€ DRAW SECTION â”€â”€ */
.dtask{background:rgba(255,214,0,.09);border:2px solid #FFD600;border-radius:10px;
  padding:12px;font-size:18px;font-weight:900;color:#FFD600;text-align:center;margin-bottom:12px;}
.cvwrap{background:rgba(0,229,255,.018);border:1px solid #1A2140;border-radius:10px;
  padding:10px;display:flex;flex-direction:column;align-items:center;margin-bottom:12px;}
#gc{display:block;border-radius:8px;background:#080B15;cursor:crosshair;touch-action:none;width:100%;max-width:290px;}
.ttools{display:flex;gap:7px;margin-top:10px;flex-wrap:wrap;justify-content:center;}
.tbtn{padding:7px 13px;border-radius:7px;border:1.5px solid #1A2140;background:#0B0D18;
  color:rgba(216,238,255,.38);font-family:'Heebo',sans-serif;font-size:14px;font-weight:900;cursor:pointer;transition:all .12s;}
.tbtn.on{border-color:#00E5FF;background:rgba(0,229,255,.1);color:#00E5FF;box-shadow:0 0 8px rgba(0,229,255,.3);}
.chkbtn{width:100%;padding:15px;border-radius:10px;border:2px solid #00FF85;background:rgba(0,255,133,.1);
  color:#00FF85;font-family:'Heebo',sans-serif;font-size:20px;font-weight:900;cursor:pointer;box-shadow:0 0 14px rgba(0,255,133,.3);}
.chkbtn:active{background:rgba(0,255,133,.2);}

/* â”€â”€ PARTICLES â”€â”€ */
.p{position:fixed;pointer-events:none;z-index:9999;animation:pfall linear forwards;}
@keyframes pfall{0%{transform:translateY(-10px) rotate(0deg);opacity:1;}100%{transform:translateY(100vh) rotate(720deg);opacity:0;}}

/* â”€â”€ BONUS TRIGGER â”€â”€ */
.bonus-trigger{
  display:none;width:100%;margin-top:18px;padding:16px;border-radius:10px;
  border:2px solid #FFD600;background:rgba(255,214,0,.08);color:#FFD600;
  font-family:'Heebo',sans-serif;font-size:20px;font-weight:900;cursor:pointer;
  box-shadow:0 0 18px rgba(255,214,0,.35);
  animation:ypulse 2.2s ease-in-out infinite;
  position:relative;z-index:1;
}
.bonus-trigger.show{display:block;}
@keyframes ypulse{0%,100%{box-shadow:0 0 18px rgba(255,214,0,.35);}50%{box-shadow:0 0 40px rgba(255,214,0,.65),0 0 70px rgba(255,214,0,.15);}}
.bonus-trigger:active{background:rgba(255,214,0,.15);}

/* â”€â”€ BONUS OVERLAY â”€â”€ */
.bov{position:fixed;inset:0;z-index:5000;background:rgba(0,0,0,.9);backdrop-filter:blur(8px);
  display:flex;align-items:center;justify-content:center;padding:16px;animation:fdin .35s ease;
  overflow-y:auto;}
.bov.hidden{display:none;}
@keyframes fdin{from{opacity:0;}to{opacity:1;}}

.bcard{
  width:100%;max-width:400px;background:#0E1122;
  border:2px solid #FFD600;border-radius:14px;
  padding:20px 18px 18px;position:relative;overflow:hidden;
  box-shadow:0 0 0 1px #07090F,0 0 40px rgba(255,214,0,.4),0 0 80px rgba(255,214,0,.08);
  animation:bonusin .5s cubic-bezier(.34,1.56,.64,1) both;
  my-margin:auto;
}
@keyframes bonusin{from{transform:scale(.72) rotate(-3deg);opacity:0;}to{transform:none;opacity:1;}}
.bcard::before{content:'';position:absolute;top:-2px;right:-2px;width:20px;height:20px;
  border-top:2.5px solid #FF1F6E;border-right:2.5px solid #FF1F6E;border-radius:0 14px 0 0;}
.bcard::after{content:'';position:absolute;bottom:-2px;left:-2px;width:20px;height:20px;
  border-bottom:2.5px solid #FF1F6E;border-left:2.5px solid #FF1F6E;border-radius:0 0 0 14px;}
.bcard>*{position:relative;z-index:1;}

.bbadge{display:flex;align-items:center;justify-content:center;gap:10px;
  border:2px solid #FFD600;border-radius:8px;padding:10px;margin-bottom:10px;
  background:rgba(255,214,0,.08);box-shadow:0 0 20px rgba(255,214,0,.35);
  animation:yflicker 5s ease-in-out infinite;}
@keyframes yflicker{0%,86%,88%,90%,100%{opacity:1;}87%,89%{opacity:.4;}}
.bbadge-txt{font-family:'Orbitron',monospace;font-weight:900;font-size:16px;color:#FFD600;letter-spacing:4px;}
.bico{font-size:20px;animation:zspin 3s linear infinite;display:inline-block;}
@keyframes zspin{to{transform:rotate(360deg);}}

.bprize{display:flex;align-items:center;justify-content:center;gap:8px;
  border:2px solid #FF1F6E;border-radius:8px;padding:10px;margin-bottom:12px;
  background:rgba(255,31,110,.08);box-shadow:0 0 16px rgba(255,31,110,.35);}
.bprize-txt{font-size:18px;font-weight:900;color:#FF1F6E;}

.btimer{background:#0B0D18;border:1.5px solid #1A2140;border-radius:10px;
  padding:12px 14px;margin-bottom:12px;
  display:grid;grid-template-columns:58px 1fr;gap:0 12px;align-items:center;}
.bhourglass{width:52px;height:52px;grid-row:1/3;}
.bnum{font-family:'Orbitron',monospace;font-weight:900;font-size:48px;
  line-height:1;color:#00E5FF;letter-spacing:2px;
  text-shadow:0 0 14px rgba(0,229,255,.5);transition:color .4s,text-shadow .4s;}
.bnum.warn{color:#FFD600;text-shadow:0 0 14px rgba(255,214,0,.5);}
.bnum.danger{color:#FF1F6E;text-shadow:0 0 14px rgba(255,31,110,.5);animation:numshk .25s infinite;}
@keyframes numshk{0%,100%{transform:translateX(0);}33%{transform:translateX(-3px);}66%{transform:translateX(3px);}}
.bbar-wrap{height:5px;background:rgba(255,255,255,.07);border-radius:3px;overflow:hidden;margin-top:8px;}
.bbar{height:100%;border-radius:3px;background:#00E5FF;box-shadow:0 0 8px rgba(0,229,255,.5);transition:width 1s linear,background .4s;}
.bbar.warn{background:#FFD600;box-shadow:0 0 8px rgba(255,214,0,.5);}
.bbar.danger{background:#FF1F6E;box-shadow:0 0 8px rgba(255,31,110,.5);animation:bblink .35s infinite;}
@keyframes bblink{0%,100%{opacity:1;}50%{opacity:.2;}}

.bclose{display:none;width:100%;margin-top:10px;padding:14px;border-radius:10px;
  border:2px solid #00E5FF;background:rgba(0,229,255,.1);color:#00E5FF;
  font-family:'Heebo',sans-serif;font-size:20px;font-weight:900;cursor:pointer;
  box-shadow:0 0 14px rgba(0,229,255,.3);}
.bclose:active{background:rgba(0,229,255,.2);}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ××¡×š ×”× ×—×™×•×ª â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="splash">
  <div class="splash-grid"></div>
  <div class="splash-inner">

    <!-- title -->
    <div class="splash-title-block">
      <div class="splash-icon">ğŸ“</div>
      <div class="splash-heading">×’×™××•××˜×¨×™×” ×¢× ××•×¨×™</div>
      <div class="splash-subtitle">×”×•×¨××•×ª ×œ××©×—×§</div>
    </div>

    <!-- topics -->
    <div class="instr-section">
      <div class="instr-label">ğŸ“š ×”× ×•×©××™×</div>
      <div class="instr-topics">
        <div class="itopic" style="--c:#00E5FF">ğŸ“ ××œ×‘×Ÿ ×•×¨×™×‘×•×¢ â€” ×©×˜×— ×•×”×™×§×£</div>
        <div class="itopic" style="--c:#FF8C00">ğŸ–¼ï¸ ×¦×•×¨×•×ª ××•×¨×›×‘×•×ª â€” ×©×˜×— ××¡×’×¨×ª</div>
        <div class="itopic" style="--c:#00FF85">ğŸ”º ××©×•×œ×© â€” ×—×™×©×•×‘ ×”×™×§×£</div>
        <div class="itopic" style="--c:#B94FFF">âœï¸ ×©×¨×˜×•×˜ ×¢×œ ×¨×©×ª</div>
        <div class="itopic" style="--c:#FF1F6E">ğŸ” ×¦×œ×¢ ×—×¡×¨×” â€” ××ª×•×š ×©×˜×—/×”×™×§×£</div>
      </div>
    </div>

    <!-- screen time -->
    <div class="instr-section">
      <div class="instr-label">ğŸ“º ×–××Ÿ ××¡×š</div>
      <div class="instr-rule">
        <div class="irule-badge" style="--c:#00FF85">âœ“</div>
        <div class="irule-text">×¢×œ ×›×œ ×ª×©×•×‘×” × ×›×•× ×” â€” <b style="color:#00FF85">+1 ×“×§×ª ××¡×š</b></div>
      </div>
    </div>

    <!-- bonus -->
    <div class="instr-section instr-bonus">
      <div class="instr-label" style="color:#FFD600">âš¡ ×©××œ×•×ª ×‘×•× ×•×¡</div>
      <div class="instr-rule">
        <div class="irule-badge" style="--c:#FFD600">4âœ“</div>
        <div class="irule-text">×›×œ <b style="color:#FFD600">4 ×ª×©×•×‘×•×ª × ×›×•× ×•×ª</b> â€” ××•×¤×™×¢×” ×©××œ×ª ×‘×•× ×•×¡</div>
      </div>
      <div class="instr-rule">
        <div class="irule-badge" style="--c:#FF1F6E">30â€³</div>
        <div class="irule-text">×™×© ×œ×š <b style="color:#FF1F6E">30 ×©× ×™×•×ª</b> ×œ×¤×ª×•×¨ â€” ××—×¨×ª ×”×©××œ×” × ×¢×œ××ª</div>
      </div>
      <div class="instr-rule">
        <div class="irule-badge" style="--c:#00FF85">+5</div>
        <div class="irule-text">×ª×©×•×‘×” × ×›×•× ×” ×‘×‘×•× ×•×¡ â€” <b style="color:#00FF85">+5 ×“×§×•×ª ××¡×š!</b></div>
      </div>
    </div>

    <button class="start-btn" onclick="startApp()">â–¶ ×‘×•××• × ×ª×—×™×œ!</button>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
<div class="wrap">

<!-- HEADER -->
<div class="hbar">
  <div class="htitle">GEO Â· ××•×¨×™</div>
  <div class="score-row">
    <div class="score-box" id="scoreBox">ğŸ“º 0 ×“×§×³</div>
    <div class="bonus-count" id="bonusCount">âš¡ 0/4</div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab on"  id="t0" onclick="goTo(0)">ğŸ“ ××œ×‘×Ÿ<div class="tab-prog" id="tp0"></div></div>
  <div class="tab"     id="t1" onclick="goTo(1)">ğŸ–¼ï¸ ××¡×’×¨×ª<div class="tab-prog" id="tp1"></div></div>
  <div class="tab"     id="t2" onclick="goTo(2)">ğŸ”º ××©×•×œ×©<div class="tab-prog" id="tp2"></div></div>
  <div class="tab"     id="t3" onclick="goTo(3)">âœï¸ ×©×¨×˜×•×˜<div class="tab-prog" id="tp3"></div></div>
  <div class="tab"     id="t4" onclick="goTo(4)">ğŸ” ×¦×œ×¢ ×—×¡×¨×”<div class="tab-prog" id="tp4"></div></div>
</div>

<div class="card" id="card">
<div class="sweep"></div>

<!-- S0 ××œ×‘×Ÿ -->
<div id="s0">
  <div class="sec-hd">
    <div class="sec-titles">
      <div class="sec-title">ğŸ“ ××œ×‘×Ÿ ×•×¨×™×‘×•×¢</div>
      <div class="sec-sub">× ×•×©× 1 â€” ×©×˜×— ×•×”×™×§×£</div>
    </div>
    <div class="sec-pbar">
      <div style="display:flex;align-items:baseline;gap:3px;justify-content:flex-end;">
        <span class="sec-pnum" id="pn0">0</span>
        <span class="sec-pmax">/10</span>
      </div>
      <div class="sec-pbtrack"><div class="sec-pbfill" id="pb0" style="width:0%;background:#00E5FF;"></div></div>
    </div>
  </div>
  <div class="shape-box" id="sh0"></div>
  <div class="fml" id="fo0"></div>
  <div class="qtext" id="qt0"></div>
  <div class="mcq"   id="mc0"></div>
  <div class="fb"    id="fb0"></div>
  <button class="nxt" id="nx0" onclick="gen(0)">×©××œ×” ×”×‘××” â†</button>
</div>

<!-- S1 ××¡×’×¨×ª -->
<div id="s1" style="display:none">
  <div class="sec-hd">
    <div class="sec-titles">
      <div class="sec-title">ğŸ–¼ï¸ ×¦×•×¨×•×ª ××•×¨×›×‘×•×ª</div>
      <div class="sec-sub">× ×•×©× 2 â€” ×©×˜×— ××¡×’×¨×ª</div>
    </div>
    <div class="sec-pbar">
      <div style="display:flex;align-items:baseline;gap:3px;justify-content:flex-end;">
        <span class="sec-pnum" id="pn1">0</span>
        <span class="sec-pmax">/10</span>
      </div>
      <div class="sec-pbtrack"><div class="sec-pbfill" id="pb1" style="width:0%;background:#FF8C00;"></div></div>
    </div>
  </div>
  <div class="shape-box" id="sh1"></div>
  <div class="fml" id="fo1"></div>
  <div class="qtext" id="qt1"></div>
  <div class="mcq"   id="mc1"></div>
  <div class="fb"    id="fb1"></div>
  <button class="nxt" id="nx1" onclick="gen(1)">×©××œ×” ×”×‘××” â†</button>
</div>

<!-- S2 ××©×•×œ×© -->
<div id="s2" style="display:none">
  <div class="sec-hd">
    <div class="sec-titles">
      <div class="sec-title">ğŸ”º ×”×™×§×£ ××©×•×œ×©</div>
      <div class="sec-sub">× ×•×©× 3 â€” ×—×™×©×•×‘ ×”×™×§×£</div>
    </div>
    <div class="sec-pbar">
      <div style="display:flex;align-items:baseline;gap:3px;justify-content:flex-end;">
        <span class="sec-pnum" id="pn2">0</span>
        <span class="sec-pmax">/10</span>
      </div>
      <div class="sec-pbtrack"><div class="sec-pbfill" id="pb2" style="width:0%;background:#00FF85;"></div></div>
    </div>
  </div>
  <div class="shape-box" id="sh2"></div>
  <div class="fml" id="fo2"></div>
  <div class="qtext" id="qt2"></div>
  <div class="mcq"   id="mc2"></div>
  <div class="fb"    id="fb2"></div>
  <button class="nxt" id="nx2" onclick="gen(2)">×©××œ×” ×”×‘××” â†</button>
</div>

<!-- S3 ×©×¨×˜×•×˜ -->
<div id="s3" style="display:none">
  <div class="sec-hd">
    <div class="sec-titles">
      <div class="sec-title">âœï¸ ×©×¨×˜×•×˜ ×¢×œ ×¨×©×ª</div>
      <div class="sec-sub">× ×•×©× 4 â€” ×©×¨×˜×•×˜ ××œ×‘×Ÿ ×•×¨×™×‘×•×¢</div>
    </div>
    <div class="sec-pbar">
      <div style="display:flex;align-items:baseline;gap:3px;justify-content:flex-end;">
        <span class="sec-pnum" id="pn3">0</span>
        <span class="sec-pmax">/10</span>
      </div>
      <div class="sec-pbtrack"><div class="sec-pbfill" id="pb3" style="width:0%;background:#B94FFF;"></div></div>
    </div>
  </div>
  <div class="dtask" id="dt">×˜×•×¢×Ÿ...</div>
  <div class="cvwrap">
    <canvas id="gc" width="290" height="290"></canvas>
    <div class="ttools">
      <button class="tbtn on" id="tb1" onclick="setTool('rect')">ğŸ“ ××œ×‘×Ÿ</button>
      <button class="tbtn"    id="tb2" onclick="setTool('sq')">â¬› ×¨×™×‘×•×¢</button>
      <button class="tbtn"            onclick="clrDraw()">ğŸ—‘ï¸ × ×§×”</button>
    </div>
  </div>
  <button class="chkbtn" onclick="chkDraw()">×‘×“×•×§ ×©×¨×˜×•×˜ âœ“</button>
  <div class="fb" id="fb3"></div>
  <button class="nxt" id="nx3" onclick="newDraw()">×©××œ×” ×”×‘××” â†</button>
</div>

<!-- S4 ×¦×œ×¢ ×—×¡×¨×” -->
<div id="s4" style="display:none">
  <div class="sec-hd">
    <div class="sec-titles">
      <div class="sec-title">ğŸ” ××¦×™××ª ×¦×œ×¢ ×—×¡×¨×”</div>
      <div class="sec-sub">× ×•×©× 5 â€” ××¦× ×¦×œ×¢ ××ª×•×š ×©×˜×—/×”×™×§×£</div>
    </div>
    <div class="sec-pbar">
      <div style="display:flex;align-items:baseline;gap:3px;justify-content:flex-end;">
        <span class="sec-pnum" id="pn4">0</span>
        <span class="sec-pmax">/10</span>
      </div>
      <div class="sec-pbtrack"><div class="sec-pbfill" id="pb4" style="width:0%;background:#FF1F6E;"></div></div>
    </div>
  </div>
  <div class="shape-box" id="sh4"></div>
  <div class="fml" id="fo4"></div>
  <div class="qtext" id="qt4"></div>
  <div class="mcq"   id="mc4"></div>
  <div class="fb"    id="fb4"></div>
  <button class="nxt" id="nx4" onclick="gen(4)">×©××œ×” ×”×‘××” â†</button>
</div>

</div><!-- /card -->

<!-- BONUS TRIGGER BTN -->
<button class="bonus-trigger" id="bonusBtn" onclick="openBonus()">âš¡ ×©××œ×ª ×‘×•× ×•×¡ ×–××™× ×”! âš¡</button>

</div><!-- /wrap -->
</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BONUS OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="bov hidden" id="bov">
  <div class="bcard">
    <div class="bbadge">
      <span class="bico">âš¡</span><span class="bbadge-txt">BONUS ROUND</span><span class="bico">âš¡</span>
    </div>
    <div class="bprize">
      <span style="font-size:22px">ğŸ“º</span>
      <span class="bprize-txt">×¢× ×” × ×›×•×Ÿ â† +5 ×“×§×•×ª ××¡×š!</span>
    </div>
    <div class="btimer">
      <svg class="bhourglass" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <clipPath id="tc"><polygon points="4,3 48,3 26,27"/></clipPath>
          <clipPath id="bc"><polygon points="26,27 4,49 48,49"/></clipPath>
          <filter id="hgf"><feGaussianBlur stdDeviation="1.5" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <polygon points="4,3 48,3 26,27"  fill="rgba(0,229,255,.07)" stroke="#00E5FF" stroke-width="1.5" filter="url(#hgf)"/>
        <polygon points="26,27 4,49 48,49" fill="rgba(0,229,255,.03)" stroke="#00E5FF" stroke-width="1.5" filter="url(#hgf)"/>
        <rect x="2"  y="1"  width="48" height="4" rx="2" fill="#00E5FF" filter="url(#hgf)"/>
        <rect x="2"  y="47" width="48" height="4" rx="2" fill="#00E5FF" filter="url(#hgf)"/>
        <rect id="sandT" x="4" y="3"  width="44" height="24" fill="#00E5FF" opacity=".7"  clip-path="url(#tc)"/>
        <rect id="sandB" x="4" y="49" width="44" height="0"  fill="#FF1F6E" opacity=".85" clip-path="url(#bc)"/>
        <circle cx="26" cy="27" r="2" fill="#00E5FF" filter="url(#hgf)">
          <animate attributeName="cy" values="28;35;28" dur=".65s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="1;.05;1" dur=".65s" repeatCount="indefinite"/>
        </circle>
      </svg>
      <div class="bnum" id="bnum">30</div>
      <div class="bbar-wrap"><div class="bbar" id="bbar"></div></div>
    </div>
    <div class="shape-box" id="bsh"></div>
    <div class="fml"        id="bfo"></div>
    <div class="qtext"      id="bqt"></div>
    <div class="mcq"        id="bmc"></div>
    <div class="fb"         id="bfb"></div>
    <button class="bclose"  id="bcl" onclick="closeBonus()">×”××©×š â†</button>
  </div>
</div>

<script>
'use strict';
// â”€â”€ UTILS â”€â”€
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function choices(correct,type){
  const s=new Set([correct]);
  let candidates=[];
  if(type==='perim'){
    // ×”×™×§×£ â€” ×ª××™×“ ×–×•×’×™, ×”×¤×¨×©×™× ×©×œ 2,4,6,8
    for(const d of[-8,-6,-4,-2,2,4,6,8,10,12]){const w=correct+d;if(w>0)candidates.push(w);}
  } else if(type==='area'){
    // ×©×˜×— â€” ×›×¤×•×œ×•×ª ×§×¨×•×‘×•×ª
    for(const d of[-12,-10,-8,-6,-4,-3,3,4,6,8,10,12,15,16]){const w=correct+d;if(w>0)candidates.push(w);}
    candidates.push(Math.round(correct*1.5),Math.round(correct*2),Math.round(correct*0.5));
  } else if(type==='side'){
    // ×¦×œ×¢ â€” ××¡×¤×¨×™× ×§×¨×•×‘×™×
    for(const d of[-4,-3,-2,-1,1,2,3,4,5]){const w=correct+d;if(w>0)candidates.push(w);}
  } else {
    for(const d of[-8,-6,-4,-3,-2,2,3,4,6,8,10,-10]){const w=correct+d;if(w>0)candidates.push(w);}
    candidates.push(Math.round(correct*1.5),Math.round(correct*2));
  }
  candidates=shuffle([...new Set(candidates)].filter(w=>w!==correct&&w>0));
  for(const w of candidates){if(s.size<4)s.add(w);}
  let k=1;while(s.size<4)s.add(correct+k++);
  return shuffle([...s]);
}
const WINS=['××ª×” ×ª×•×ª×—! ×ª×©×•×‘×” × ×›×•× ×” ğŸ¯','××™ ×”×’××•×Ÿ ×©×œ ××‘×? ğŸ†','×ª×©×•×‘×” × ×›×•× ×” ×™× ××œ×š! ğŸ‘‘','××•×¨×™×§×™ ×”××œ×š! ğŸŒŸ','×•×•××•, ×¤×¦×¦×”! âœ¨'];

// â”€â”€ PARTICLES â”€â”€
function boom(n){
  const C=['#00E5FF','#FF1F6E','#FFD600','#00FF85','#B94FFF','#FF8C00'];
  for(let i=0;i<n;i++){
    const d=document.createElement('div');d.className='p';
    const sz=4+Math.random()*8;
    d.style.cssText=`left:${Math.random()*100}vw;top:-12px;width:${sz}px;height:${sz}px;background:${C[Math.floor(Math.random()*C.length)]};animation-duration:${.7+Math.random()*1.5}s;animation-delay:${Math.random()*.4}s;border-radius:${Math.random()>.4?'50%':'2px'};box-shadow:0 0 4px currentColor`;
    document.body.appendChild(d);setTimeout(()=>d.remove(),3e3);
  }
}

// â”€â”€ SVG HELPERS â”€â”€
const DF=`<defs><filter id="gf"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>`;
function nb(cx,cy,val,col,fs){
  const s=String(val),w=s.length*fs*.67+22,h=fs+18;
  return `<rect x="${cx-w/2}" y="${cy-h/2}" width="${w}" height="${h}" rx="6" fill="rgba(7,9,15,.96)" stroke="${col}" stroke-width="2"/>
<text x="${cx}" y="${cy+fs*.37}" fill="${col}" font-family="Orbitron,monospace" font-weight="900" font-size="${fs}" text-anchor="middle" filter="url(#gf)">${val}</text>`;
}
function qb(cx,cy,col,fs){
  const w=fs*.67+34,h=fs+18;
  return `<rect x="${cx-w/2}" y="${cy-h/2}" width="${w}" height="${h}" rx="6" fill="rgba(7,9,15,.96)" stroke="${col}" stroke-width="2.5"><animate attributeName="stroke-opacity" values="1;.15;1" dur=".85s" repeatCount="indefinite"/></rect>
<text x="${cx}" y="${cy+fs*.37}" fill="${col}" font-family="Orbitron,monospace" font-weight="900" font-size="${fs}" text-anchor="middle" filter="url(#gf)"><animate attributeName="opacity" values="1;.15;1" dur=".85s" repeatCount="indefinite"/>?</text>`;
}

function svgRect(a,b,col,hl,hideB){
  const W=380,H=180;
  // fix size so max dimension = 140px, both scale together
  const maxDim=Math.max(a,b);
  const unit=Math.min(140/maxDim, 22);
  const rw=Math.round(a*unit), rh=Math.round(b*unit);
  const rx=(W-rw)/2,ry=50;
  const fA=hl==='area'?`<rect x="${rx+1}" y="${ry+1}" width="${rw-2}" height="${rh-2}" rx="3" fill="${col}40"><animate attributeName="opacity" values=".4;1;.4" dur="1.4s" repeatCount="indefinite"/></rect>`:'';
  const pL=2*(rw+rh);
  const pA=hl==='perim'?`<rect x="${rx}" y="${ry}" width="${rw}" height="${rh}" fill="none" stroke="${col}" stroke-width="5" rx="4" stroke-dasharray="${pL}" stroke-dashoffset="0" opacity=".85"><animate attributeName="stroke-dashoffset" values="0;${pL}" dur="2s" repeatCount="indefinite"/></rect>`:'';
  const tCy=ry-28,rCx=Math.min(W-34,rx+rw+44),rCy=ry+rh/2;
  return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" overflow="visible">${DF}
<rect x="${rx}" y="${ry}" width="${rw}" height="${rh}" fill="${col}16" stroke="${col}" stroke-width="2.5" rx="4"/>
${fA}${pA}
<line x1="${rx}" y1="${ry}" x2="${rx+11}" y2="${ry}" stroke="${col}" stroke-width="2.5"/>
<line x1="${rx}" y1="${ry}" x2="${rx}" y2="${ry+11}" stroke="${col}" stroke-width="2.5"/>
<line x1="${rx+rw}" y1="${ry+rh}" x2="${rx+rw-11}" y2="${ry+rh}" stroke="${col}" stroke-width="2.5"/>
<line x1="${rx+rw}" y1="${ry+rh}" x2="${rx+rw}" y2="${ry+rh-11}" stroke="${col}" stroke-width="2.5"/>
${nb(rx+rw/2,tCy,a,col,28)}
${hideB?qb(rCx,rCy,col,28):nb(rCx,rCy,b,col,28)}
</svg>`;
}

function svgFrame(A,B,a,b,col){
  const W=340,H=190,sc=Math.min((W-100)/A,(H-80)/B);
  const BW=A*sc,BH=B*sc,BX=(W-BW)/2,BY=(H-BH)/2;
  const hw=a*sc,hh=b*sc,hx=(W-hw)/2,hy=(H-hh)/2;
  return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" overflow="visible">${DF}
<rect x="${BX}" y="${BY}" width="${BW}" height="${BH}" fill="${col}16" stroke="${col}" stroke-width="2.5" rx="4"/>
<rect x="${hx}" y="${hy}" width="${hw}" height="${hh}" fill="#07090F" stroke="#FF1F6E" stroke-width="2" stroke-dasharray="5,3" rx="3"/>
${nb(W/2,BY-26,A,col,26)}${nb(BX-34,BY+BH/2,B,col,26)}${nb(W/2,hy+hh/2,a+'Ã—'+b,'#FF1F6E',18)}
</svg>`;
}

function svgLshape(W,H,cw,ch,col){
  const sc=16,px=30,py=20,TW=W*sc,TH=H*sc,CW=cw*sc,CH=ch*sc;
  // L-shape polygon (remaining area)
  const pts=`${px},${py} ${px+TW-CW},${py} ${px+TW-CW},${py+CH} ${px+TW},${py+CH} ${px+TW},${py+TH} ${px},${py+TH}`;
  const VW=TW+90,VH=TH+70;
  // corner cut-out x,y
  const cx=px+TW-CW, cy=py;
  return `<svg viewBox="0 0 ${VW} ${VH}" xmlns="http://www.w3.org/2000/svg" overflow="visible">${DF}
<!-- remaining L area - pulsing fill -->
<polygon points="${pts}" fill="${col}30" stroke="${col}" stroke-width="2.5" stroke-linejoin="round">
  <animate attributeName="fill-opacity" values=".18;.45;.18" dur="1.6s" repeatCount="indefinite"/>
</polygon>
<polygon points="${pts}" fill="none" stroke="${col}" stroke-width="2.5" stroke-linejoin="round"/>
<!-- cut corner - dashed -->
<rect x="${cx}" y="${cy}" width="${CW}" height="${CH}" fill="#FF1F6E18" stroke="#FF1F6E" stroke-width="2" stroke-dasharray="5,3">
  <animate attributeName="stroke-opacity" values="1;.3;1" dur="1s" repeatCount="indefinite"/>
</rect>
<!-- outer dimensions -->
${nb(px+TW/2, py-26, W, col, 22)}
${nb(px-30, py+TH/2, H, col, 22)}
<!-- cut corner dimensions ON the dashed lines -->
<text x="${cx+CW/2}" y="${cy-10}" fill="#FF1F6E" font-family="Orbitron,monospace" font-weight="900" font-size="14" text-anchor="middle">${cw}</text>
<text x="${cx+CW+14}" y="${cy+CH/2+5}" fill="#FF1F6E" font-family="Orbitron,monospace" font-weight="900" font-size="14" text-anchor="start">${ch}</text>
</svg>`;
}
function svgTshape(a1,b1,a2,b2,col){
  const sc=16,px=30,py=15,W1=a1*sc,H1=b1*sc,W2=a2*sc,H2=b2*sc;
  const x2=px+Math.max(0,(W1-W2)/2),y2=py+H1;
  const VW=Math.max(W1,W2)+80,VH=H1+H2+60;
  return `<svg viewBox="0 0 ${VW} ${VH}" xmlns="http://www.w3.org/2000/svg" overflow="visible">${DF}
<rect x="${px}" y="${py}" width="${W1}" height="${H1}" fill="${col}16" stroke="${col}" stroke-width="2.5" rx="3"/>
<rect x="${x2}" y="${y2}" width="${W2}" height="${H2}" fill="${col}22" stroke="${col}" stroke-width="2.5" rx="3"/>
${nb(px+W1/2,py-22,a1,col,22)}${nb(px-26,py+H1/2,b1,col,22)}
${nb(x2+W2/2,y2+H2+22,a2,'#FF1F6E',22)}${nb(x2-26,y2+H2/2,b2,'#FF1F6E',22)}
</svg>`;
}

function svgTri(a,b,c,col,hl,hideC){
  const W=380,H=205,px=[190,W-55,55],py=[42,H-46,H-46];
  const pts=`${px[0]},${py[0]} ${px[1]},${py[1]} ${px[2]},${py[2]}`,pL=420;
  const fA=hl==='area'?`<polygon points="${pts}" fill="${col}38"><animate attributeName="opacity" values=".4;1;.4" dur="1.4s" repeatCount="indefinite"/></polygon>`:'';
  const pA=hl==='perim'?`<polygon points="${pts}" fill="none" stroke="${col}" stroke-width="5" stroke-linejoin="round" stroke-dasharray="${pL}" stroke-dashoffset="0" opacity=".85"><animate attributeName="stroke-dashoffset" values="0;${pL}" dur="2.2s" repeatCount="indefinite"/></polygon>`:'';
  const lx=(px[0]+px[2])/2-46,ly=(py[0]+py[2])/2,rx2=(px[0]+px[1])/2+46,ry2=(py[0]+py[1])/2,bx=(px[1]+px[2])/2,by=py[2]+34;
  return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" overflow="visible">${DF}
<polygon points="${pts}" fill="${col}10" stroke="${col}" stroke-width="2.5" stroke-linejoin="round"/>
${fA}${pA}${nb(lx,ly,a,col,26)}${nb(rx2,ry2,b,col,26)}${hideC?qb(bx,by,'#FF1F6E',26):nb(bx,by,c,col,26)}
</svg>`;
}

// â”€â”€ MCQ â”€â”€
function buildMCQ(id,correct,onPick,type){
  const el=document.getElementById(id);el.innerHTML='';
  choices(correct,type).forEach(v=>{
    const btn=document.createElement('button');btn.className='mb';btn.textContent=v;
    btn.onclick=()=>onPick(btn,v,correct);el.appendChild(btn);
  });
}
function lockMCQ(id){document.querySelectorAll('#'+id+' .mb').forEach(b=>{b.disabled=true;b.style.pointerEvents='none';});}
function showFb(id,cls,msg,sub){const el=document.getElementById(id);el.className='fb '+cls;el.innerHTML=msg+(sub?`<div class="fb-sub">${sub}</div>`:'');}

// â”€â”€ SCORING â”€â”€
let totalScore=0;
let bonusStreak=0;
const BONUS_TRIGGER=4;
let bonusReady=false;
const secProgress={0:0,1:0,2:0,3:0,4:0};

// â”€â”€ DATA TRACKING â”€â”€
const SEC_NAMES=['××œ×‘×Ÿ ×•×¨×™×‘×•×¢','×¦×•×¨×•×ª ××•×¨×›×‘×•×ª','××©×•×œ×©','×©×¨×˜×•×˜','×¦×œ×¢ ×—×¡×¨×”'];
let stats={
  sessionStart: Date.now(),
  totalMinutes: 0,
  correct: [0,0,0,0,0],   // per section
  wrong:   [0,0,0,0,0],   // per section
  sessions: []
};
const FB='https://ori-geo-default-rtdb.firebaseio.com';
async function loadStats(){
  try{
    const r=await fetch(FB+'/ori/stats.json');
    if(r.ok){const s=await r.json();
      if(s){stats.totalMinutes=s.totalMinutes||0;stats.correct=s.correct||[0,0,0,0,0];stats.wrong=s.wrong||[0,0,0,0,0];stats.sessions=s.sessions||[];stats.screenMinutes=s.screenMinutes||0;}
      totalScore=stats.totalMinutes;
      document.getElementById('scoreBox').textContent='ğŸ“º '+totalScore+' ×“×§×³';
    }
  }catch(e){}
  try{
    const r=await fetch(FB+'/ori/difficulty.json');
    if(r.ok){const d=await r.json();if(d)window._oriDifficulty=parseInt(d)||5;}
  }catch(e){}
}
let _saveTimer=null;
function saveStats(){
  stats.totalMinutes=totalScore;
  clearTimeout(_saveTimer);
  _saveTimer=setTimeout(async()=>{
    try{await fetch(FB+'/ori/stats.json',{method:'PUT',body:JSON.stringify(stats)});}catch(e){}
  },1500);
}
function trackScreen(min){stats.screenMinutes=(stats.screenMinutes||0)+min;saveStats();}
function trackCorrect(sec){stats.correct[sec]=(stats.correct[sec]||0)+1;saveStats();}
function trackWrong(sec){stats.wrong[sec]=(stats.wrong[sec]||0)+1;saveStats();}
function trackTime(){
  const mins=Math.round((Date.now()-stats.sessionStart)/60000);
  if(mins>0){
    stats.sessions.push({date:new Date().toLocaleDateString('he-IL'),mins});
    // keep last 30 sessions only
    if(stats.sessions.length>30)stats.sessions=stats.sessions.slice(-30);
  }
  saveStats();
}
// save session time every minute
setInterval(()=>{trackTime();},60000);
window.addEventListener('beforeunload',trackTime);

function addScore(min){
  totalScore+=min;
  stats.totalMinutes+=min;
  trackScreen(min);
  document.getElementById('scoreBox').textContent='ğŸ“º '+totalScore+' ×“×§×³';
  // flash
  const sb=document.getElementById('scoreBox');
  sb.style.boxShadow='0 0 22px rgba(255,214,0,.8)';
  setTimeout(()=>sb.style.boxShadow='0 0 10px rgba(255,214,0,.3)',600);
}
function incStreak(){
  bonusStreak++;
  if(bonusStreak>=BONUS_TRIGGER){
    bonusStreak=0;
    bonusReady=true;
    document.getElementById('bonusBtn').classList.add('show');
    boom(40);
  }
  updateStreakUI();
}
function updateStreakUI(){
  const bc=document.getElementById('bonusCount');
  if(bonusReady){
    bc.textContent='âš¡ BONUS!';bc.className='bonus-count lit';
  } else {
    bc.textContent='âš¡ '+bonusStreak+'/'+BONUS_TRIGGER;
    bc.className='bonus-count'+(bonusStreak>0?' lit':'');
  }
}
let totalAnswered=0;
let currentSec=0;
function addSecProgress(sec){
  secProgress[sec]=Math.min(secProgress[sec]+1,10);
  const n=secProgress[sec];
  document.getElementById('pn'+sec).textContent=n;
  document.getElementById('pb'+sec).style.width=(n/10*100)+'%';
  if(n>0)document.getElementById('tp'+sec).textContent=n+'/10';
  totalAnswered++;
}
function rotateRandom(fromSec){
  const others=[0,1,2,3,4].filter(i=>i!==fromSec);
  const next=others[rnd(0,others.length-1)];
  currentSec=next;
  goTo(next);
  if(next===0)genRect();
  else if(next===1)genFrame();
  else if(next===2)genTri();
  else if(next===3)newDraw();
  else if(next===4)genMissing();
  // flash notification
  const notif=document.createElement('div');
  notif.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;background:#FFD600;color:#07090F;font-family:Heebo,sans-serif;font-weight:900;font-size:18px;padding:12px 24px;border-radius:10px;box-shadow:0 0 20px rgba(255,214,0,.5)';
  notif.textContent='ğŸ”€ ×¢×•×‘×¨×™× ×œ× ×•×©× ×—×“×©!';
  document.body.appendChild(notif);
  setTimeout(()=>notif.remove(),2000);
}

// â”€â”€ SECTION STATE â”€â”€
const isDone={0:false,1:false,2:false,4:false};
function pick(sec,btn,v,correct){
  if(isDone[sec])return;
  if(v===correct){
    isDone[sec]=true;btn.classList.add('ok');lockMCQ('mc'+sec);
    boom(80);
    showFb('fb'+sec,'ok',WINS[rnd(0,WINS.length-1)],'+1 ×“×§×ª ××¡×š ğŸ“º');
    document.getElementById('nx'+sec).style.display='none';
    addScore(1);
    incStreak();
    addSecProgress(sec);
    trackCorrect(sec);
    // after 1.5 sec - go to random new section
    setTimeout(()=>rotateRandom(sec),1500);
  } else {
    btn.classList.add('no');showFb('fb'+sec,'no','×”×ª×©×•×‘×” ×œ× × ×›×•× ×” ğŸ’ª','×ª×ª×¨×›×– ×•×ª× ×¡×” ×©×•×‘!');
    trackWrong(sec);
    setTimeout(()=>{btn.classList.remove('no');document.getElementById('fb'+sec).className='fb';gen(sec);},2000);
  }
}
function resetSec(sec){isDone[sec]=false;document.getElementById('fb'+sec).className='fb';document.getElementById('nx'+sec).style.display='none';}

// â”€â”€ GEN FUNCTIONS â”€â”€
function gen(sec){
  resetSec(sec);
  if(sec===0)genRect();
  else if(sec===1)genFrame();
  else if(sec===2)genTri();
  else if(sec===4)genMissing();
}

function genRect(){
  const CY='#00E5FF',YE='#FFD600',GR='#00FF85',MA='#FF1F6E';
  const pool=[
    // ×¢×' 78 - ×©×˜×—
    ()=>({ans:21,shape:svgRect(7,3,CY,'area',false),type:'area',chip:'×©×˜×— = ××•×¨×š Ã— ×¨×•×—×‘',q:`××œ×‘×Ÿ ××•×¨×š=<b style="color:${CY}">7</b>, ×¨×•×—×‘=<b style="color:${CY}">3</b> â€” ××” ×”<b style="color:${MA}">×©×˜×—</b>?`}),
    ()=>({ans:20,shape:svgRect(5,4,CY,'area',false),type:'area',chip:'×©×˜×— = ××•×¨×š Ã— ×¨×•×—×‘',q:`××œ×‘×Ÿ ××•×¨×š=<b style="color:${CY}">5</b>, ×¨×•×—×‘=<b style="color:${CY}">4</b> â€” ××” ×”<b style="color:${MA}">×©×˜×—</b>?`}),
    ()=>({ans:9,shape:svgRect(3,3,GR,'area',false),type:'area',chip:'×©×˜×— = ×¦×œ×¢ Ã— ×¦×œ×¢',q:`×¨×™×‘×•×¢ ×¦×œ×¢=<b style="color:${GR}">3</b> â€” ××” ×”<b style="color:${MA}">×©×˜×—</b>?`}),
    ()=>({ans:12,shape:svgRect(3,4,CY,'area',false),type:'area',chip:'×©×˜×— = ××•×¨×š Ã— ×¨×•×—×‘',q:`××œ×‘×Ÿ ××•×¨×š=<b style="color:${CY}">4</b>, ×¨×•×—×‘=<b style="color:${CY}">3</b> â€” ××” ×”<b style="color:${MA}">×©×˜×—</b>?`}),
    // ×¢×' 95 - ×”×™×§×£
    ()=>({ans:12,shape:svgRect(4,2,YE,'perim',false),type:'perim',chip:'×”×™×§×£ = 2Ã—(××•×¨×š+×¨×•×—×‘)',q:`××œ×‘×Ÿ ××•×¨×š=<b style="color:${YE}">4</b>, ×¨×•×—×‘=<b style="color:${YE}">2</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`}),
    ()=>({ans:20,shape:svgRect(5,5,YE,'perim',false),type:'perim',chip:'×”×™×§×£ = 4 Ã— ×¦×œ×¢',q:`×¨×™×‘×•×¢ ×¦×œ×¢=<b style="color:${YE}">5</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`}),
    ()=>({ans:20,shape:svgRect(7,3,YE,'perim',false),type:'perim',chip:'×”×™×§×£ = 2Ã—(××•×¨×š+×¨×•×—×‘)',q:`××œ×‘×Ÿ ××•×¨×š=<b style="color:${YE}">7</b>, ×¨×•×—×‘=<b style="color:${YE}">3</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`}),
    ()=>({ans:14,shape:svgRect(6,1,YE,'perim',false),type:'perim',chip:'×”×™×§×£ = 2Ã—(××•×¨×š+×¨×•×—×‘)',q:`××œ×‘×Ÿ ××•×¨×š=<b style="color:${YE}">6</b>, ×¨×•×—×‘=<b style="color:${YE}">1</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`}),
    ()=>({ans:12,shape:svgRect(3,3,YE,'perim',false),type:'perim',chip:'×”×™×§×£ = 4 Ã— ×¦×œ×¢',q:`×¨×™×‘×•×¢ ×¦×œ×¢=<b style="color:${YE}">3</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`}),
    // ×©××œ×•×ª ×‘×¨××” ×“×•××”
    ()=>{const a=rnd(4,12),b=rnd(2,7);return{ans:a*b,shape:svgRect(a,b,CY,'area',false),type:'area',chip:'×©×˜×— = ××•×¨×š Ã— ×¨×•×—×‘',q:`××œ×‘×Ÿ ××•×¨×š=<b style="color:${CY}">${a}</b>, ×¨×•×—×‘=<b style="color:${CY}">${b}</b> â€” ××” ×”<b style="color:${MA}">×©×˜×—</b>?`};},
    ()=>{const s=rnd(3,9);return{ans:s*s,shape:svgRect(s,s,GR,'area',false),type:'area',chip:'×©×˜×— = ×¦×œ×¢ Ã— ×¦×œ×¢',q:`×¨×™×‘×•×¢ ×¦×œ×¢=<b style="color:${GR}">${s}</b> â€” ××” ×”<b style="color:${MA}">×©×˜×—</b>?`};},
    ()=>{const a=rnd(4,12),b=rnd(2,6);return{ans:2*(a+b),shape:svgRect(a,b,YE,'perim',false),type:'perim',chip:'×”×™×§×£ = 2Ã—(××•×¨×š+×¨×•×—×‘)',q:`××œ×‘×Ÿ ××•×¨×š=<b style="color:${YE}">${a}</b>, ×¨×•×—×‘=<b style="color:${YE}">${b}</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`};},
    ()=>{const s=rnd(3,9);return{ans:4*s,shape:svgRect(s,s,YE,'perim',false),type:'perim',chip:'×”×™×§×£ = 4 Ã— ×¦×œ×¢',q:`×¨×™×‘×•×¢ ×¦×œ×¢=<b style="color:${YE}">${s}</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`};},
  ];
  const p=pool[rnd(0,pool.length-1)]();
  document.getElementById('sh0').innerHTML=p.shape;
  document.getElementById('fo0').innerHTML=`<div class="chip">${p.chip}</div>`;
  document.getElementById('qt0').innerHTML=p.q;
  buildMCQ('mc0',p.ans,(btn,v,c)=>pick(0,btn,v,c),p.type);
}

function genFrame(){
  const OR='#FF8C00',MA='#FF1F6E';
  const pool=[
    // ×¢×' 82 - ×—×™×‘×•×¨
    ()=>({ans:55+16,shape:svgTshape(11,5,4,4,OR),chip:'×©×˜×— = ××œ×‘×Ÿ × + ××œ×‘×Ÿ ×‘',q:`×¦×•×¨×” ××•×¨×›×‘×ª: <b style="color:${OR}">11Ã—5</b> + <b style="color:${MA}">4Ã—4</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×”×›×•×œ×œ</b>?`}),
    ()=>({ans:33+6,shape:svgTshape(11,3,3,2,OR),chip:'×©×˜×— = ××œ×‘×Ÿ × + ××œ×‘×Ÿ ×‘',q:`×¦×•×¨×” ××•×¨×›×‘×ª: <b style="color:${OR}">11Ã—3</b> + <b style="color:${MA}">3Ã—2</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×”×›×•×œ×œ</b>?`}),
    // ×¢×' 80 - ×©× ×™ ×¨×™×‘×•×¢×™×
    ()=>({ans:18,shape:svgTshape(3,3,3,3,OR),chip:'×©×˜×— = ×¨×™×‘×•×¢ × + ×¨×™×‘×•×¢ ×‘',q:`×©× ×™ ×¨×™×‘×•×¢×™× <b style="color:${OR}">3Ã—3</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×”×›×•×œ×œ</b>?`}),
    ()=>({ans:25,shape:svgTshape(4,4,3,3,OR),chip:'×©×˜×— = ×¨×™×‘×•×¢ × + ×¨×™×‘×•×¢ ×‘',q:`×¨×™×‘×•×¢ <b style="color:${OR}">4Ã—4</b> + ×¨×™×‘×•×¢ <b style="color:${MA}">3Ã—3</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×”×›×•×œ×œ</b>?`}),
    ()=>({ans:24+15,shape:svgTshape(8,3,5,3,OR),chip:'×©×˜×— = ××œ×‘×Ÿ × + ××œ×‘×Ÿ ×‘',q:`××œ×‘×Ÿ <b style="color:${OR}">8Ã—3</b> + ××œ×‘×Ÿ <b style="color:${MA}">5Ã—3</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×”×›×•×œ×œ</b>?`}),
    // ×¢×' 81 - L-shape ×—×™×¡×•×¨
    ()=>({ans:5*7-2*2,shape:svgLshape(7,5,2,2,OR),chip:'×©×˜×— = ××œ×‘×Ÿ ×’×“×•×œ âˆ’ ×¤×™× ×”',q:`××œ×‘×Ÿ <b style="color:${OR}">7Ã—5</b>, ×—×ª×›× ×• ×¤×™× ×” <b style="color:${MA}">2Ã—2</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×©× ×©××¨</b>?`}),
    ()=>({ans:8*4-3*3,shape:svgLshape(8,4,3,3,OR),chip:'×©×˜×— = ××œ×‘×Ÿ ×’×“×•×œ âˆ’ ×¤×™× ×”',q:`××œ×‘×Ÿ <b style="color:${OR}">8Ã—4</b>, ×—×ª×›× ×• ×¤×™× ×” <b style="color:${MA}">3Ã—3</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×©× ×©××¨</b>?`}),
    ()=>({ans:6*4-2*3,shape:svgLshape(6,4,2,3,OR),chip:'×©×˜×— = ××œ×‘×Ÿ ×’×“×•×œ âˆ’ ×¤×™× ×”',q:`××œ×‘×Ÿ <b style="color:${OR}">6Ã—4</b>, ×—×ª×›× ×• ×¤×™× ×” <b style="color:${MA}">2Ã—3</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×©× ×©××¨</b>?`}),
    // ×©××œ×•×ª ×‘×¨××” ×“×•××”
    ()=>{const a1=rnd(5,11),b1=rnd(2,5),a2=rnd(2,5),b2=rnd(2,4);return{ans:a1*b1+a2*b2,shape:svgTshape(a1,b1,a2,b2,OR),chip:'×©×˜×— = ××œ×‘×Ÿ × + ××œ×‘×Ÿ ×‘',q:`×¦×•×¨×” ××•×¨×›×‘×ª: <b style="color:${OR}">${a1}Ã—${b1}</b> + <b style="color:${MA}">${a2}Ã—${b2}</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×”×›×•×œ×œ</b>?`};},
    ()=>{const W=rnd(6,10),H=rnd(4,7),cw=rnd(2,W-2),ch=rnd(2,H-2);return{ans:W*H-cw*ch,shape:svgLshape(W,H,cw,ch,OR),chip:'×©×˜×— = ××œ×‘×Ÿ ×’×“×•×œ âˆ’ ×¤×™× ×”',q:`××œ×‘×Ÿ <b style="color:${OR}">${W}Ã—${H}</b>, ×—×ª×›× ×• ×¤×™× ×” <b style="color:${MA}">${cw}Ã—${ch}</b> â€” ××” ×”<b style="color:${MA}">×©×˜×— ×©× ×©××¨</b>?`};},
  ];
  const p=pool[rnd(0,pool.length-1)]();
  document.getElementById('sh1').innerHTML=p.shape;
  document.getElementById('fo1').innerHTML=`<div class="chip">${p.chip}</div>`;
  document.getElementById('qt1').innerHTML=p.q;
  buildMCQ('mc1',p.ans,(btn,v,c)=>pick(1,btn,v,c),'area');
}

function genTri(){
  const tp=rnd(0,2),GR='#00FF85',CY='#00E5FF',YE='#FFD600',MA='#FF1F6E';
  let ans,shape,chip,q;
  if(tp===0){const a=rnd(3,14),b=rnd(3,14),c=rnd(3,14);ans=a+b+c;shape=svgTri(a,b,c,GR,'perim',false);chip='P = × + ×‘ + ×’';q=`××©×•×œ×©, ×¦×œ×¢×•×ª <b style="color:${GR}">${a}, ${b}, ${c}</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`;}
  else if(tp===1){const leg=rnd(4,14),base=rnd(3,12);ans=leg*2+base;shape=svgTri(leg,leg,base,YE,'perim',false);chip='P = 2Ã—×©×•×§ + ×‘×¡×™×¡';q=`×©×•×•×” ×©×•×§×™×™×, ×©×•×§=<b style="color:${YE}">${leg}</b>, ×‘×¡×™×¡=<b style="color:${YE}">${base}</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`;}
  else{const a=rnd(3,12),b=rnd(3,12),P=rnd(a+b+4,a+b+18),c=P-a-b;ans=c;shape=svgTri(a,b,c,CY,'area',true);chip='×’ = ×”×™×§×£ âˆ’ × âˆ’ ×‘';q=`×”×™×§×£=<b style="color:${CY}">${P}</b>, ×=<b style="color:${CY}">${a}</b>, ×‘=<b style="color:${CY}">${b}</b> â€” ××” <b style="color:${MA}">×¦×œ×¢ ×’</b>?`;}
  document.getElementById('sh2').innerHTML=shape;
  document.getElementById('fo2').innerHTML=`<div class="chip">${chip}</div>`;
  document.getElementById('qt2').innerHTML=q;
  buildMCQ('mc2',ans,(btn,v,c)=>pick(2,btn,v,c),'perim');
}

function genMissing(){
  const MA='#FF1F6E';
  const pool=[
    // ×¢×' 83 - ×©×˜×— × ×ª×•×Ÿ
    ()=>({ans:4, shape:svgRect(16,4,MA,'area',true),chip:'×¨×•×—×‘ = ×©×˜×— Ã· ××•×¨×š',q:`×©×˜×—=<b style="color:${MA}">64 ×¡×"×¨</b>, ××•×¨×š=<b style="color:${MA}">16</b> â€” ××” ×”<b style="color:${MA}">×¨×•×—×‘</b>?`}),
    ()=>({ans:2, shape:svgRect(12,2,MA,'area',true),chip:'×¨×•×—×‘ = ×©×˜×— Ã· ××•×¨×š',q:`×©×˜×—=<b style="color:${MA}">24 ×¡×"×¨</b>, ××•×¨×š=<b style="color:${MA}">12</b> â€” ××” ×”<b style="color:${MA}">×¨×•×—×‘</b>?`}),
    ()=>({ans:6, shape:svgRect(6,6,MA,'area',true),chip:'×¦×œ×¢ = âˆš×©×˜×—',q:`×¨×™×‘×•×¢, ×©×˜×—=<b style="color:${MA}">36 ×¡×"×¨</b> â€” ××” ×”<b style="color:${MA}">×¦×œ×¢</b>?`}),
    ()=>({ans:4, shape:svgRect(7,4,MA,'area',true),chip:'×¨×•×—×‘ = ×©×˜×— Ã· ××•×¨×š',q:`×©×˜×—=<b style="color:${MA}">28 ×¡×"×¨</b>, ××•×¨×š=<b style="color:${MA}">7</b> â€” ××” ×”<b style="color:${MA}">×¨×•×—×‘</b>?`}),
    ()=>({ans:6, shape:svgRect(8,6,MA,'area',true),chip:'×¨×•×—×‘ = ×©×˜×— Ã· ××•×¨×š',q:`×©×˜×—=<b style="color:${MA}">48 ×¡×"×¨</b>, ××•×¨×š=<b style="color:${MA}">8</b> â€” ××” ×”<b style="color:${MA}">×¨×•×—×‘</b>?`}),
    ()=>({ans:3, shape:svgRect(3,3,MA,'area',true),chip:'×¦×œ×¢ = âˆš×©×˜×—',q:`×¨×™×‘×•×¢, ×©×˜×—=<b style="color:${MA}">9 ×¡×"×¨</b> â€” ××” ×”<b style="color:${MA}">×¦×œ×¢</b>?`}),
    // ×¢×' 98 - ×”×™×§×£ × ×ª×•×Ÿ
    ()=>({ans:9, shape:svgRect(9,9,MA,'perim',true),chip:'×¦×œ×¢ = ×”×™×§×£ Ã· 4',q:`×¨×™×‘×•×¢, ×”×™×§×£=<b style="color:${MA}">36 ×¡×"×</b> â€” ××” ×”<b style="color:${MA}">×¦×œ×¢</b>?`}),
    ()=>({ans:4, shape:svgRect(16,4,MA,'perim',true),chip:'×¨×•×—×‘ = (×”×™×§×£Ã·2) âˆ’ ××•×¨×š',q:`×”×™×§×£=<b style="color:${MA}">40 ×¡×"×</b>, ××•×¨×š=<b style="color:${MA}">16</b> â€” ××” ×”<b style="color:${MA}">×¨×•×—×‘</b>?`}),
    ()=>({ans:12,shape:svgRect(2,12,MA,'perim',true),chip:'×¨×•×—×‘ = (×”×™×§×£Ã·2) âˆ’ ××•×¨×š',q:`×”×™×§×£=<b style="color:${MA}">28 ×¡×"×</b>, ××•×¨×š=<b style="color:${MA}">2</b> â€” ××” ×”<b style="color:${MA}">×¨×•×—×‘</b>?`}),
    ()=>({ans:7, shape:svgRect(7,7,MA,'perim',true),chip:'×¦×œ×¢ = ×”×™×§×£ Ã· 4',q:`×¨×™×‘×•×¢, ×”×™×§×£=<b style="color:${MA}">28 ×¡×"×</b> â€” ××” ×”<b style="color:${MA}">×¦×œ×¢</b>?`}),
    // ×©××œ×•×ª ×‘×¨××” ×“×•××”
    ()=>{const a=rnd(4,12),b=rnd(2,7);return{ans:b,shape:svgRect(a,b,MA,'area',true),chip:'×¨×•×—×‘ = ×©×˜×— Ã· ××•×¨×š',q:`×©×˜×—=<b style="color:${MA}">${a*b} ×¡×"×¨</b>, ××•×¨×š=<b style="color:${MA}">${a}</b> â€” ××” ×”<b style="color:${MA}">×¨×•×—×‘</b>?`};},
    ()=>{const s=[3,4,5,6,7,8,9][rnd(0,6)];return{ans:s,shape:svgRect(s,s,MA,'area',true),chip:'×¦×œ×¢ = âˆš×©×˜×—',q:`×¨×™×‘×•×¢, ×©×˜×—=<b style="color:${MA}">${s*s} ×¡×"×¨</b> â€” ××” ×”<b style="color:${MA}">×¦×œ×¢</b>?`};},
    ()=>{const a=rnd(4,12),b=rnd(2,6);return{ans:b,shape:svgRect(a,b,MA,'perim',true),chip:'×¨×•×—×‘ = (×”×™×§×£Ã·2) âˆ’ ××•×¨×š',q:`×”×™×§×£=<b style="color:${MA}">${2*(a+b)} ×¡×"×</b>, ××•×¨×š=<b style="color:${MA}">${a}</b> â€” ××” ×”<b style="color:${MA}">×¨×•×—×‘</b>?`};},
    ()=>{const s=rnd(3,10);return{ans:s,shape:svgRect(s,s,MA,'perim',true),chip:'×¦×œ×¢ = ×”×™×§×£ Ã· 4',q:`×¨×™×‘×•×¢, ×”×™×§×£=<b style="color:${MA}">${4*s} ×¡×"×</b> â€” ××” ×”<b style="color:${MA}">×¦×œ×¢</b>?`};},
  ];
  const p=pool[rnd(0,pool.length-1)]();
  document.getElementById('sh4').innerHTML=p.shape;
  document.getElementById('fo4').innerHTML=`<div class="chip">${p.chip}</div>`;
  document.getElementById('qt4').innerHTML=p.q;
  buildMCQ('mc4',p.ans,(btn,v,c)=>pick(4,btn,v,c),'side');
}

// â”€â”€ DRAW â”€â”€
let dctx=null,dtool='rect',dstart=null,drawing=false,userShape=null,dtarget=null;
const GS=29,GC=10,GR2=10;
const DRAWS=[
  {txt:'×¦×™×™×¨ ××œ×‘×Ÿ 5Ã—3',shape:'rect',w:5,h:3},{txt:'×¦×™×™×¨ ×¨×™×‘×•×¢ 4Ã—4',shape:'sq',s:4},
  {txt:'×¦×™×™×¨ ××œ×‘×Ÿ 6Ã—2',shape:'rect',w:6,h:2},{txt:'×¦×™×™×¨ ×¨×™×‘×•×¢ 3Ã—3',shape:'sq',s:3},
  {txt:'×¦×™×™×¨ ××œ×‘×Ÿ 4Ã—5',shape:'rect',w:4,h:5},{txt:'×¦×™×™×¨ ×¨×™×‘×•×¢ 5Ã—5',shape:'sq',s:5},
  {txt:'×¦×™×™×¨ ××œ×‘×Ÿ 7Ã—3',shape:'rect',w:7,h:3},{txt:'×¦×™×™×¨ ×¨×™×‘×•×¢ 6Ã—6',shape:'sq',s:6},
  {txt:'×¦×™×™×¨ ××œ×‘×Ÿ 8Ã—2',shape:'rect',w:8,h:2},{txt:'×¦×™×™×¨ ××œ×‘×Ÿ 3Ã—7',shape:'rect',w:3,h:7},
];

function initDraw(){
  const cv=document.getElementById('gc');if(!cv)return;
  dctx=cv.getContext('2d');
  const pos=e=>{const r=cv.getBoundingClientRect(),sc=cv.width/r.width,src=e.touches?e.touches[0]:e;return{x:Math.floor((src.clientX-r.left)*sc/GS),y:Math.floor((src.clientY-r.top)*sc/GS)};};
  cv.addEventListener('mousedown',e=>{e.preventDefault();drawing=true;dstart=pos(e);userShape=null;});
  cv.addEventListener('touchstart',e=>{e.preventDefault();drawing=true;dstart=pos(e);userShape=null;},{passive:false});
  cv.addEventListener('mousemove',e=>{if(!drawing)return;drawGrid();preview(dstart,pos(e));});
  cv.addEventListener('touchmove',e=>{e.preventDefault();if(!drawing)return;drawGrid();preview(dstart,pos(e));},{passive:false});
  cv.addEventListener('mouseup',e=>{if(!drawing)return;drawing=false;finalize(dstart,pos(e));});
  cv.addEventListener('touchend',e=>{if(!drawing)return;drawing=false;const t=e.changedTouches[0],r=cv.getBoundingClientRect(),sc=cv.width/r.width;finalize(dstart,{x:Math.floor((t.clientX-r.left)*sc/GS),y:Math.floor((t.clientY-r.top)*sc/GS)});});
  newDraw();
}
function drawGrid(){if(!dctx)return;const cv=document.getElementById('gc');
  dctx.clearRect(0,0,cv.width,cv.height);
  // filled squares background
  dctx.fillStyle='#0A0D1A';dctx.fillRect(0,0,cv.width,cv.height);
  // grid dots at intersections
  for(let i=0;i<=GC;i++){for(let j=0;j<=GR2;j++){
    dctx.beginPath();dctx.arc(i*GS,j*GS,1.5,0,Math.PI*2);
    dctx.fillStyle='rgba(0,229,255,.35)';dctx.fill();
  }}
  // grid lines
  dctx.strokeStyle='rgba(0,229,255,.18)';dctx.lineWidth=0.8;
  for(let i=0;i<=GC;i++){dctx.beginPath();dctx.moveTo(i*GS,0);dctx.lineTo(i*GS,GR2*GS);dctx.stroke();}
  for(let j=0;j<=GR2;j++){dctx.beginPath();dctx.moveTo(0,j*GS);dctx.lineTo(GC*GS,j*GS);dctx.stroke();}
}
function preview(a,b){if(!dctx||!a||!b)return;
  const dw=Math.abs(b.x-a.x),dh=Math.abs(b.y-a.y);
  const x1=Math.min(a.x,b.x)*GS,y1=Math.min(a.y,b.y)*GS,w=dw*GS,h=dh*GS;
  // fill
  dctx.fillStyle='rgba(0,229,255,.35)';dctx.fillRect(x1,y1,w||1,h||1);
  // border
  dctx.strokeStyle='#00E5FF';dctx.lineWidth=3;dctx.setLineDash([]);dctx.strokeRect(x1,y1,w||1,h||1);
  // live area label
  if(dw>0&&dh>0){
    const area=dw*dh;
    const label=dw+'Ã—'+dh+'='+area+' ×¡×"×¨';
    dctx.font='bold 16px Orbitron,monospace';
    const tw=dctx.measureText(label).width+16;
    const lx=x1+w/2,ly=y1-18;
    dctx.fillStyle='rgba(7,9,15,.92)';dctx.fillRect(lx-tw/2,ly-13,tw,22);
    dctx.fillStyle='#FFD600';dctx.textAlign='center';dctx.textBaseline='middle';
    dctx.fillText(label,lx,ly);
  }
}
function finalize(a,b){
  userShape={x1:Math.min(a.x,b.x),y1:Math.min(a.y,b.y),x2:Math.max(a.x,b.x),y2:Math.max(a.y,b.y)};
  drawGrid();
  const x1=userShape.x1*GS,y1=userShape.y1*GS;
  const dw=userShape.x2-userShape.x1,dh=userShape.y2-userShape.y1;
  const w=dw*GS,h=dh*GS;
  if(w<1||h<1)return;
  // strong fill
  dctx.fillStyle='rgba(0,229,255,.45)';dctx.fillRect(x1,y1,w,h);
  // inner grid on filled area
  dctx.strokeStyle='rgba(255,255,255,.2)';dctx.lineWidth=0.5;
  for(let i=userShape.x1;i<=userShape.x2;i++){dctx.beginPath();dctx.moveTo(i*GS,y1);dctx.lineTo(i*GS,y1+h);dctx.stroke();}
  for(let j=userShape.y1;j<=userShape.y2;j++){dctx.beginPath();dctx.moveTo(x1,j*GS);dctx.lineTo(x1+w,j*GS);dctx.stroke();}
  // bold border
  dctx.strokeStyle='#00E5FF';dctx.lineWidth=3;dctx.setLineDash([]);dctx.strokeRect(x1,y1,w,h);
  // area label above shape
  if(dw>0&&dh>0){
    const area=dw*dh;
    const label=dw+'Ã—'+dh+'='+area+' ×¡×"×¨';
    dctx.font='bold 16px Orbitron,monospace';
    const tw=dctx.measureText(label).width+16;
    const lx=x1+w/2,ly=y1-18;
    dctx.fillStyle='rgba(7,9,15,.92)';dctx.fillRect(lx-tw/2,ly-13,tw,22);
    dctx.fillStyle='#FFD600';dctx.textAlign='center';dctx.textBaseline='middle';
    dctx.fillText(label,lx,ly);
  }
}

function clrDraw(){userShape=null;drawGrid();}
function setTool(t){dtool=t;document.getElementById('tb1').className='tbtn'+(t==='rect'?' on':'');document.getElementById('tb2').className='tbtn'+(t==='sq'?' on':'');}
function newDraw(){
  dtarget=DRAWS[rnd(0,DRAWS.length-1)];
  document.getElementById('dt').textContent='ğŸ¯ ××©×™××”: '+dtarget.txt;
  document.getElementById('fb3').className='fb';
  document.getElementById('nx3').style.display='none';
  userShape=null;drawGrid();
}
function chkDraw(){
  const fb=document.getElementById('fb3');
  if(!userShape||userShape.x2<=userShape.x1||userShape.y2<=userShape.y1){fb.className='fb wn';fb.innerHTML='âš ï¸ ×§×•×“× ×¦×™×™×¨ ×¦×•×¨×” ×¢×œ ×”×¨×©×ª!';return;}
  const dw=userShape.x2-userShape.x1,dh=userShape.y2-userShape.y1,t=dtarget;
  const ok=(t.shape==='rect'&&((dw===t.w&&dh===t.h)||(dw===t.h&&dh===t.w)))||(t.shape==='sq'&&dw===dh&&dw===t.s);
  if(ok){
    boom(80);
    const area=(t.shape==='sq'?t.s*t.s:t.w*t.h);
    fb.className='fb ok';
    fb.innerHTML=WINS[rnd(0,WINS.length-1)]+'<div class="fb-sub">×©×¨×˜×•×˜ ××•×©×œ×! +1 ×“×§×ª ××¡×š ğŸ“º</div>'
      +`<div class="area-q">ğŸ“ ××” ×”×©×˜×— ×©×œ ××” ×©×¡×¨×˜×ª? <b style="color:#FFD600">${area} ×¡×"×¨</b></div>`;
    addScore(1);incStreak();addSecProgress(3);trackCorrect(3);
    setTimeout(()=>rotateRandom(3),2000);
  } else {
    trackWrong(3);fb.className='fb no';fb.innerHTML='×œ× ××“×•×™×§ ğŸ’ª<div class="fb-sub">× ×“×¨×©: '+(t.shape==='sq'?'×¨×™×‘×•×¢ '+t.s+'Ã—'+t.s:'××œ×‘×Ÿ '+t.w+'Ã—'+t.h)+'</div>';
    setTimeout(()=>newDraw(),2000);
  }
}

// â”€â”€ NAVIGATION â”€â”€
const TAB_COLS=['#00E5FF','#FF8C00','#00FF85','#B94FFF','#FF1F6E'];
function goTo(idx){
  [0,1,2,3,4].forEach(i=>{document.getElementById('s'+i).style.display=i===idx?'block':'none';});
  document.querySelectorAll('.tab').forEach((t,i)=>{
    const c=TAB_COLS[i];
    if(i===idx){t.className='tab on';t.style.borderColor=c;t.style.color=c;t.style.background=c+'1A';t.style.boxShadow=`0 0 12px ${c}55`;}
    else{t.className='tab';t.style.borderColor='';t.style.color='';t.style.background='';t.style.boxShadow='';}
  });
  const c=TAB_COLS[idx];
  const card=document.getElementById('card');
  card.style.borderColor=c;card.style.boxShadow=`0 0 34px ${c}50,0 0 0 1px #07090F`;
  window.scrollTo({top:0,behavior:'smooth'});
}
function goToAndGen(idx){
  goTo(idx);
  if(idx===0)genRect();
  else if(idx===1)genFrame();
  else if(idx===2)genTri();
  else if(idx===3)newDraw();
  else if(idx===4)genMissing();
}

// â”€â”€ SPLASH â†’ APP â”€â”€
async function startApp(){
  boom(60);
  const splash=document.getElementById('splash');
  const app=document.getElementById('app');
  splash.style.transition='opacity .5s';
  splash.style.opacity='0';
  setTimeout(async()=>{
    splash.classList.add('splash-hidden');
    app.classList.add('show');
    await loadStats();genRect();genFrame();genTri();genMissing();const startSec=rnd(0,4);goTo(startSec);
    setTimeout(initDraw,80);
  },500);
}

// â”€â”€ BONUS â”€â”€
const BTOTAL=30;
let btimer=null,bsec=0,bdone=false,bans=0;

function openBonus(){
  bdone=false;bsec=BTOTAL;
  bonusReady=false;
  document.getElementById('bonusBtn').classList.remove('show');
  document.getElementById('bonusCount').textContent='âš¡ 0/'+BONUS_TRIGGER;
  document.getElementById('bonusCount').className='bonus-count';
  document.getElementById('bfb').className='fb';
  document.getElementById('bcl').style.display='none';
  document.getElementById('bov').classList.remove('hidden');
  boom(50);
  genBonus();
  startBTimer();
}

function genBonus(){
  const tp=rnd(0,3),CY='#00E5FF',YE='#FFD600',GR='#00FF85',MA='#FF1F6E';
  let ans,shape,chip,q;
  if(tp===0){const a=rnd(4,12),b=rnd(3,10);ans=a*b;shape=svgRect(a,b,CY,'area',false);chip='A = a Ã— b';q=`××œ×‘×Ÿ <b style="color:${CY}">a=${a}</b>, <b style="color:${CY}">b=${b}</b> â€” ××” ×”<b style="color:${MA}">×©×˜×—</b>?`;}
  else if(tp===1){const a=rnd(4,12),b=rnd(3,10);ans=2*(a+b);shape=svgRect(a,b,YE,'perim',false);chip='P = 2Ã—(a+b)';q=`××œ×‘×Ÿ <b style="color:${YE}">a=${a}</b>, <b style="color:${YE}">b=${b}</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`;}
  else if(tp===2){const a=rnd(3,14),b=rnd(3,14),c=rnd(3,14);ans=a+b+c;shape=svgTri(a,b,c,GR,'perim',false);chip='P = × + ×‘ + ×’';q=`××©×•×œ×© <b style="color:${GR}">${a}, ${b}, ${c}</b> â€” ××” ×”<b style="color:${MA}">×”×™×§×£</b>?`;}
  else{const s=rnd(3,12);ans=s*s;shape=svgRect(s,s,GR,'area',false);chip='A = aÂ²';q=`×¨×™×‘×•×¢, ×¦×œ×¢=<b style="color:${GR}">${s}</b> â€” ××” ×”<b style="color:${MA}">×©×˜×—</b>?`;}
  bans=ans;
  document.getElementById('bsh').innerHTML=shape;
  document.getElementById('bfo').innerHTML=`<div class="chip">${chip}</div>`;
  document.getElementById('bqt').innerHTML=q;
  buildMCQ('bmc',ans,pickBonus);
}

function pickBonus(btn,v,correct){
  if(bdone)return;
  const elapsed=BTOTAL-bsec;
  if(v===correct){
    bdone=true;clearInterval(btimer);
    btn.classList.add('ok');lockMCQ('bmc');
    boom(120);
    addScore(5);saveStats();
    showFb('bfb','ok',WINS[rnd(0,WINS.length-1)],'+5 ×“×§×•×ª ××¡×š × ×•×¡×¤×•! ğŸ“º');
    document.getElementById('bcl').style.display='block';
  } else {
    btn.classList.add('no');
    if(elapsed<=3){
      showFb('bfb','wn','âš ï¸ ×œ× ×œ× ×—×©!','×ª×¡×ª×›×œ ×¢×œ ×”×©××œ×” ×•×ª×—×©×•×‘...');
    } else {
      showFb('bfb','no','×”×ª×©×•×‘×” ×œ× × ×›×•× ×” ğŸ’ª','×ª×ª×¨×›×– ×•×ª× ×¡×” ×©×•×‘!');
    }
    setTimeout(()=>{btn.classList.remove('no');document.getElementById('bfb').className='fb';},2000);
  }
}

function startBTimer(){
  updateBTimer();
  clearInterval(btimer);
  btimer=setInterval(()=>{
    if(bdone){clearInterval(btimer);return;}
    bsec--;updateBTimer();
    if(bsec<=0){clearInterval(btimer);bonusTimeout();}
  },1000);
}

function updateBTimer(){
  const p=bsec/BTOTAL;
  const num=document.getElementById('bnum');
  const bar=document.getElementById('bbar');
  num.textContent=bsec;
  bar.style.width=(p*100)+'%';
  if(bsec<=10){num.className='bnum danger';bar.className='bbar danger';}
  else if(bsec<=20){num.className='bnum warn';bar.className='bbar warn';}
  else{num.className='bnum';bar.className='bbar';}
  const th=Math.max(0,p*24);
  document.getElementById('sandT').setAttribute('height',th);
  const bh=Math.max(0,(1-p)*24);
  document.getElementById('sandB').setAttribute('y',49-bh);
  document.getElementById('sandB').setAttribute('height',bh);
}

function bonusTimeout(){
  bdone=true;
  document.querySelectorAll('#bmc .mb').forEach(b=>{
    b.disabled=true;
    if(Number(b.textContent)===bans)b.classList.add('ok');
  });
  document.getElementById('bnum').textContent='--';
  showFb('bfb','no','âŒ› ×”×–××Ÿ × ×’××¨!',`×”×ª×©×•×‘×” ×”× ×›×•× ×” ×”×™×™×ª×”: ${bans}`);
  document.getElementById('bcl').style.display='block';
}

function closeBonus(){
  clearInterval(btimer);
  document.getElementById('bov').classList.add('hidden');
}
</script>
</body>
</html>
